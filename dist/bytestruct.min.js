let e=/(le|be)|(byte)|(?:([fsu])(8|16|32|64))|(\d+)|(\w+):|(\s+)|(.)/g,t={8:1,16:2,32:4,64:8,b:1},r={f:"Float",s:"Int",u:"Uint",b:"Uint"};export function bytes(t,...r){let l,i,n=0,f=[],o=(e,t)=>{({0:()=>{if(Array.isArray(e))f.push({name:e,label:i}),i=void 0;else if(t[1])l="le"===t[1];else if(t[2]){let e={name:"b"};null!=i&&(e.label=i,i=void 0),f.push(e)}else if(t[3]){let e=t[3],r=t[4],n={name:e,size:r,littleEndian:l};null!=i&&(n.label=i,i=void 0),f.push(n)}else t[6]?i=t[6]:"*"===t[8]&&(n=1)},1:()=>{if(!t||t[5]){let r=e??parseInt(t[5]);f.at(-1).repeat=r,n=0}}})[n]()};for(let l=0;l<t.length;l++){let i=t[l],n=i.matchAll(e);for(let e of n)e[7]||o(void 0,e);l<r.length&&o(r[l])}return f}export function sizeOf(e){let r=0;for(let l of e){let e=Array.isArray(l.name)?sizeOf(l.name):t[l.size??l.name];l.repeat&&(e*=l.repeat),r+=e}return r}export function writeStructInto(e,l,i,n){let f=n;for(let{name:n,size:o,littleEndian:s,repeat:u,label:a}of l){let l=Array.isArray(n)?t=>f+=writeStructInto(e,n,t,f):l=>{let i=t[o??n],u=("s"===n||"u"===n)&&64===o?`Big${r[n]}`:r[n];e[`set${u}${"b"===n?8:o}`](f,l,s),f+=i},c=i[a];if(u)for(let e=0;e<u;e++)l(c[e]);else l(c)}return f-n}export function readStructFrom(e,l,i){let n={},f=i;for(let{name:i,size:o,littleEndian:s,repeat:u,label:a}of l){let l=t[o??i];if(!a){f+=l;continue}if(Array.isArray(i)){let t=sizeOf(i);if(u){let r=[];for(let l=0;l<u;l++)r[l]=readStructFrom(e,i,f),f+=t;n[a]=r}else n[a]=readStructFrom(e,i,f),f+=t;continue}if("b"===i){let t=u??1,r=new Uint8Array(e.buffer);n[a]=r.slice(f,f+t),f+=t}else{let t=("s"===i||"u"===i)&&64===o?`Big${r[i]}`:r[i],c=e[`get${t}${o}`].bind(e);if(u){let e=[];for(let t=0;t<u;t++)e[t]=c(f,s),f+=l;n[a]=e}else n[a]=c(f,s),f+=l}}return n}export function readBytesFrom(e,l,i){let n=i,f=[];for(let i=0;i<l.length;i++){let{name:o,size:s,littleEndian:u,repeat:a}=l[i];if("b"===o){let t=a??1,r=new Uint8Array(e.buffer),l=r.slice(n,n+t);f.push.apply(f,l),n+=t;continue}let c=t[s],b=("s"===o||"u"===o)&&64===s?`Big${r[o]}`:r[o],p=e[`get${b}${s}`].bind(e);if(a)for(let e=0;e<a;e++){let e=p(n,u);f.push(e),n+=c}else{let e=p(n,u);f.push(e),n+=c}}return f}export function writeBytesInto(e,l,i,n){let f=n,o=0;for(let n=0;n<l.length;n++){let{name:s,size:u,littleEndian:a,repeat:c}=l[n];if("b"===s){let t=c??1,r=i.slice(o,o+t),l=new Uint8Array(e.buffer);l.set(r,f),f+=t,o+=t;continue}let b=t[u],p=("s"===s||"u"===s)&&64===u?`Big${r[s]}`:r[s],y=e[`set${p}${u}`].bind(e);if(c)for(let e=0;e<c;e++)y(f,i[o],a),f+=b,o+=1;else y(f,i[o],a),f+=b,o+=1}return f-n}
