const t=/(le|be)|(byte)|(?:([fsu])(8|16|32|64))|(\d+)|(\w+):|(\s+)|(.)/g,e={8:1,16:2,32:4,64:8,b:1},n={f:"Float",s:"Int",u:"Uint",b:"Uint"};export function bytes(e,...n){let r,o,s=0,i=[];const f=(t,e)=>{({0:()=>{if(Array.isArray(t))i.push({name:t,label:o}),o=void 0;else if(e[1])r="le"===e[1];else if(e[2]){let t={name:"b"};null!=o&&(t.label=o,o=void 0),i.push(t)}else if(e[3]){let t=e[3],n=e[4],s={name:t,size:n,littleEndian:r};null!=o&&(s.label=o,o=void 0),i.push(s)}else e[6]?o=e[6]:"*"===e[8]&&(s=1)},1:()=>{if(!e||e[5]){const n=t??parseInt(e[5]);i.at(-1).repeat=n,s=0}}})[s]()};for(let r=0;r<e.length;r++){const o=e[r],s=o.matchAll(t);for(const t of s)t[7]||f(void 0,t);r<n.length&&f(n[r])}return i}export function sizeOf(t){let n=0;for(const r of t){let t=Array.isArray(r.name)?sizeOf(r.name):e[r.size??r.name];r.repeat&&(t*=r.repeat),n+=t}return n}export function writeStructInto(t,r,o,s){let i=s;for(const{name:s,size:f,littleEndian:l,repeat:c,label:u}of r){const r=Array.isArray(s)?e=>i+=writeStructInto(t,s,e,i):r=>{const o=e[f??s],c=("s"===s||"u"===s)&&64===f?`Big${n[s]}`:n[s];t[`set${c}${"b"===s?8:f}`](i,r,l),i+=o},a=o[u];if(c)for(let t=0;t<c;t++)r(a[t]);else r(a)}return i-s}export function readStructFrom(t,r,o){const s={};let i=o;for(const{name:o,size:f,littleEndian:l,repeat:c,label:u}of r){const r=e[f??o];if(!u){i+=r;continue}if(Array.isArray(o)){const e=sizeOf(o);if(c){const n=[];for(let r=0;r<c;r++)n[r]=readStructFrom(t,o,i),i+=e;s[u]=n}else s[u]=readStructFrom(t,o,i),i+=e;continue}if("b"===o){const e=c??1,n=new Uint8Array(t.buffer);s[u]=n.slice(i,i+e),i+=e}else{const e=("s"===o||"u"===o)&&64===f?`Big${n[o]}`:n[o],a=t[`get${e}${f}`].bind(t);if(c){const t=[];for(let e=0;e<c;e++)t[e]=a(i,l),i+=r;s[u]=t}else s[u]=a(i,l),i+=r}}return s}export function readBytesFrom(t,r,o){let s=o,i=[];for(let o=0;o<r.length;o++){const{name:f,size:l,littleEndian:c,repeat:u}=r[o];if("b"===f){const e=u??1,n=new Uint8Array(t.buffer),r=n.slice(s,s+e);i.push.apply(i,r),s+=e;continue}const a=e[l],b=("s"===f||"u"===f)&&64===l?`Big${n[f]}`:n[f],p=t[`get${b}${l}`].bind(t);if(u)for(let t=0;t<u;t++){const t=p(s,c);i.push(t),s+=a}else{const t=p(s,c);i.push(t),s+=a}}return i}export function writeBytesInto(t,r,o,s){let i=s,f=0;for(let s=0;s<r.length;s++){const{name:l,size:c,littleEndian:u,repeat:a}=r[s];if("b"===l){const e=a??1,n=o.slice(f,f+e),r=new Uint8Array(t.buffer);r.set(n,i),i+=e,f+=e;continue}const b=e[c],p=("s"===l||"u"===l)&&64===c?`Big${n[l]}`:n[l],y=t[`set${p}${c}`].bind(t);if(a)for(let t=0;t<a;t++)y(i,o[f],u),i+=b,f+=1;else y(i,o[f],u),i+=b,f+=1}return i-s}
